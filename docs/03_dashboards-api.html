<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>R training: Liverpool City Region - 3&nbsp; Dashboards and APIs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./04_data-modeling.html" rel="next">
<link href="./02_data-visualisation.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03_dashboards-api.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Dashboards and APIs</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R training: Liverpool City Region</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/fcorowe/lcr-training" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R Fundamentals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_data-visualisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Visualisation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_dashboards-api.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Dashboards and APIs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_data-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data modeling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_data-description.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar"><div class="quarto-margin-header"><div class="margin-header-item">
<p><img src="./cover.png" class="img-fluid"></p>
</div></div>
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives"><span class="header-section-number">3.1</span> Learning Objectives</a></li>
  <li><a href="#introduction-to-apis" id="toc-introduction-to-apis" class="nav-link" data-scroll-target="#introduction-to-apis"><span class="header-section-number">3.2</span> Introduction to APIs</a>
  <ul class="collapse">
  <li><a href="#independent-exercise---over-to-you-15---20-mins" id="toc-independent-exercise---over-to-you-15---20-mins" class="nav-link" data-scroll-target="#independent-exercise---over-to-you-15---20-mins"><span class="header-section-number">3.2.1</span> Independent exercise - Over to you! (15 - 20 mins)</a></li>
  <li><a href="#advanced-bulk-downloading" id="toc-advanced-bulk-downloading" class="nav-link" data-scroll-target="#advanced-bulk-downloading"><span class="header-section-number">3.2.2</span> Advanced Bulk Downloading</a></li>
  </ul></li>
  <li><a href="#using-the-nomis-api" id="toc-using-the-nomis-api" class="nav-link" data-scroll-target="#using-the-nomis-api"><span class="header-section-number">3.3</span> Using the NOMIS API</a>
  <ul class="collapse">
  <li><a href="#independent-exercise---over-to-you" id="toc-independent-exercise---over-to-you" class="nav-link" data-scroll-target="#independent-exercise---over-to-you"><span class="header-section-number">3.3.1</span> Independent exercise - Over to you!</a></li>
  </ul></li>
  <li><a href="#building-dashboards-in-r" id="toc-building-dashboards-in-r" class="nav-link" data-scroll-target="#building-dashboards-in-r"><span class="header-section-number">3.4</span> Building Dashboards in R</a>
  <ul class="collapse">
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started"><span class="header-section-number">3.4.1</span> Getting started</a></li>
  <li><a href="#introduction-to-flex-dashboard" id="toc-introduction-to-flex-dashboard" class="nav-link" data-scroll-target="#introduction-to-flex-dashboard"><span class="header-section-number">3.4.2</span> Introduction to Flex Dashboard</a></li>
  <li><a href="#independent-exercise---over-to-you-1" id="toc-independent-exercise---over-to-you-1" class="nav-link" data-scroll-target="#independent-exercise---over-to-you-1"><span class="header-section-number">3.4.3</span> Independent exercise - Over to you!</a></li>
  <li><a href="#embedding-visualisations" id="toc-embedding-visualisations" class="nav-link" data-scroll-target="#embedding-visualisations"><span class="header-section-number">3.4.4</span> Embedding visualisations</a></li>
  <li><a href="#independent-exercise---over-to-you-30---45-mins" id="toc-independent-exercise---over-to-you-30---45-mins" class="nav-link" data-scroll-target="#independent-exercise---over-to-you-30---45-mins"><span class="header-section-number">3.4.5</span> Independent exercise - Over to you!! (30 - 45 mins)</a></li>
  </ul></li>
  <li><a href="#other-useful-reporting-techniques" id="toc-other-useful-reporting-techniques" class="nav-link" data-scroll-target="#other-useful-reporting-techniques"><span class="header-section-number">3.5</span> Other Useful Reporting Techniques</a>
  <ul class="collapse">
  <li><a href="#constructing-reports" id="toc-constructing-reports" class="nav-link" data-scroll-target="#constructing-reports"><span class="header-section-number">3.5.1</span> Constructing Reports</a></li>
  <li><a href="#routine-reporting" id="toc-routine-reporting" class="nav-link" data-scroll-target="#routine-reporting"><span class="header-section-number">3.5.2</span> Routine Reporting</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Dashboards and APIs</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">3.1</span> Learning Objectives</h2>
<p>By the end of today’s session you should be able to:</p>
<ol type="1">
<li>Understand the basic principles of APIs</li>
<li>Download and visualise data from NOMIS using the NOMIS API</li>
<li>Understand the basic principles of flexdashboard</li>
<li>Build a basic dashboard using flexdashboard</li>
</ol>
</section>
<section id="introduction-to-apis" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="introduction-to-apis"><span class="header-section-number">3.2</span> Introduction to APIs</h2>
<p>Web services make their data easily accessible to computer programs like R through use of an Application Programming Interface (API). Today’s practical will teach you how to access data from APIs, and load them into your R environment for analysis.</p>
<p>To download data from an API you need to send a HTTP request to a server, which tells the server to return the specific parcel of data that matches the criteria in the HTTP request.</p>
<p>For example, on NOMIS there is a page called <a href="https://www.nomisweb.co.uk/sources/census_2021_bulk">‘Census 2021 Bulk Data Download’</a>, which contains .zip files for different tables of data available from the latest census.</p>
<p>Now you should go to the <a href="https://www.nomisweb.co.uk/sources/census_2021_bulk">‘Census 2021 Bulk Data Download’</a> page, and see what it contains.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/nomis.png" class="img-fluid figure-img"></p>
<figcaption>NOMIS</figcaption>
</figure>
</div>
<p>There are lots of files on the web page - e.g.&nbsp;<code>census2021-ts001.zip</code>, <code>census2021-ts007a.zip</code>.</p>
<p>You can click on these files individually, download them to your PC, unzip them and read them into R. Alternatively, we can programmatically download the data directly from the webpage. If you ‘right click’ on one of the .zip files and press ‘copy link’, you will have a URL which can access that specific .zip file, as below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://www.nomisweb.co.uk/output/census/2021/census2021-ts061.zip"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "https://www.nomisweb.co.uk/output/census/2021/census2021-ts061.zip"</code></pre>
</div>
</div>
<p>The specific URL above relates to table <a href="https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/bulletins/traveltoworkenglandandwales/census2021">TS061 - “Method of Travel to Work”</a>, which is the same dataset we have been using throughout this course.</p>
<p>Now I’m going to show you how to download the .zip file, and read in the file of data we used yesterday. This is a really basic example of using an API, which shows how you can download data from NOMIS into your environment, without having to physically go and download it, save it to a folder, unzip it and read it into memory.</p>
<p>First, let’s download the .zip file - this line of code downloads the .zip file to your local machine. It creates a new file in your working directory called ‘temp.zip’ - go and take a look!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Download the .zip file, using the url set above</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(url, <span class="st">"temp.zip"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we need to unzip the folder, to get to the datasets stored within:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## First set where you want the unzipped files to be stored</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>outDir <span class="ot">&lt;-</span> <span class="st">"data/unzip"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Unzip the folder to the data/unzip folder</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(<span class="st">"temp.zip"</span>, <span class="at">exdir =</span> outDir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ok so now that you’ve downloaded the files to your local machine, we can look and see what files are available to us:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Use list.files() to see what we unzipped</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"data/unzip"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "census2021-ts061-ctry.csv" "census2021-ts061-lsoa.csv"
[3] "census2021-ts061-ltla.csv" "census2021-ts061-msoa.csv"
[5] "census2021-ts061-oa.csv"   "census2021-ts061-rgn.csv" 
[7] "census2021-ts061-utla.csv" "metadata"                 </code></pre>
</div>
</div>
<p>Thankfully, NOMIS use a really standard naming protocol for their files, which makes it really easy to tell what each of the files contains. If you cast your mind back to yesterday, we used a file called “census2021-ts061-lsoa.csv”, which we provided to you as part of the course materials. However, as you can see from the code above, you have now programmatically downloaded the same file, which we can read in:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Read in the LSOA census data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/unzip/census2021-ts061-lsoa.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="independent-exercise---over-to-you-15---20-mins" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="independent-exercise---over-to-you-15---20-mins"><span class="header-section-number">3.2.1</span> Independent exercise - Over to you! (15 - 20 mins)</h3>
<ol type="1">
<li>As a recap, see if you can reproduce one of the visualisations we produced yesterday using the data we have just scraped from the API.</li>
<li>Test downloading two more datasets from NOMIS, by swapping in new URLs, and reading in one of the files from the folder you download.</li>
<li>(<em>optional</em>) Produce an interesting visualisation from that new dataset.</li>
</ol>
<p><strong>Solution 2</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set the new URL</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>url2 <span class="ot">&lt;-</span> <span class="st">"https://www.nomisweb.co.uk/output/census/2021/census2021-ts066.zip"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Download the files</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(url2, <span class="st">"temp2.zip"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Unzip the files</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>outDir2 <span class="ot">&lt;-</span> <span class="st">"data/unzip2"</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Unzip the folder to the data/unzip folder</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(<span class="st">"temp2.zip"</span>, <span class="at">exdir =</span> outDir2)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Read in the LSOA census data</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>db2 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/unzip2/census2021-ts066-lsoa.csv"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Select some columns to work with, and calculate % student</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>db2_clean <span class="ot">&lt;-</span> db2 <span class="sc">%&gt;%</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(geography.code, Economic.activity.status..Total..All.usual.residents.aged.<span class="fl">16.</span>years.and.over, Economic.activity.status..Economically.inactive..Student) <span class="sc">%&gt;%</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">"LSOA21CD"</span>, <span class="st">"total"</span>, <span class="st">"student"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">student =</span> (student <span class="sc">/</span> total) <span class="sc">*</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Solution 3</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Produce a histogram</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> db2_clean, <span class="fu">aes</span>(<span class="at">x =</span> student)) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Population who are students (%)"</span>, <span class="at">y =</span> <span class="st">"Number of LSOAs"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Data: UK Census (2021) - 'Economic Activity Status' (ts066)"</span>) <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03_dashboards-api_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So what have we achieved?</p>
<ol type="1">
<li>You can now programmatically download datasets from the NOMIS bulk census page, without needing to download the files.</li>
<li>You can produce visualisations using these different datasets.</li>
<li>You are in a position to automate download and visualisation of census data from NOMIS.</li>
</ol>
</section>
<section id="advanced-bulk-downloading" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="advanced-bulk-downloading"><span class="header-section-number">3.2.2</span> Advanced Bulk Downloading</h3>
<p>But what if you want to automate this download in a much quicker manner. The NOMIS API is a good way of doing this (and we’ll be discussing this shortly), but the other way you can do this is through the use of functions.</p>
<p>Functions are “self contained modules of code that accomplish a specific task”. They normally take data in soem form, perform a number of modifications to it, and then return some form of result.</p>
<p>The basic syntax of a function is as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Specify a new function</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>function1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are three important things to notice here:</p>
<ol type="1">
<li>Function name (e.g., <code>function1</code>) - enables you to call the function at a later point.</li>
<li>Object (e.g., <code>function(x)</code>) - is the input data or parameter that you are going to be using.</li>
<li>Steps (e.g., <code>{}</code>) - anything within the curly brackets will be a series of steps that are applied.</li>
</ol>
<p>So a basic example is we can ask the function to return the first five rows of x:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Specify a new function - first five</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>firstfive <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(x)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now you need to run the function on an object - let’s do it on our census dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Apply the function</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">firstfive</span>(db)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  date                 geography geography.code
1 2021       City of London 001A      E01000001
2 2021       City of London 001B      E01000002
3 2021       City of London 001C      E01000003
4 2021       City of London 001E      E01000005
5 2021 Barking and Dagenham 016A      E01000006
6 2021 Barking and Dagenham 015A      E01000007
  Method.of.travel.to.workplace..Total..All.usual.residents.aged.16.years.and.over.in.employment.the.week.before.the.census
1                                                                                                                       866
2                                                                                                                       881
3                                                                                                                      1000
4                                                                                                                       496
5                                                                                                                       888
6                                                                                                                      1385
  Method.of.travel.to.workplace..Work.mainly.at.or.from.home
1                                                        639
2                                                        676
3                                                        618
4                                                        203
5                                                        192
6                                                        370
  Method.of.travel.to.workplace..Underground..metro..light.rail..tram
1                                                                  35
2                                                                  31
3                                                                  74
4                                                                  69
5                                                                 205
6                                                                 358
  Method.of.travel.to.workplace..Train
1                                   17
2                                   10
3                                   21
4                                   25
5                                  104
6                                  177
  Method.of.travel.to.workplace..Bus..minibus.or.coach
1                                                   13
2                                                   15
3                                                   26
4                                                   44
5                                                   60
6                                                  117
  Method.of.travel.to.workplace..Taxi
1                                   4
2                                   2
3                                   4
4                                   2
5                                   1
6                                   8
  Method.of.travel.to.workplace..Motorcycle..scooter.or.moped
1                                                           3
2                                                           1
3                                                           4
4                                                           3
5                                                           5
6                                                           3
  Method.of.travel.to.workplace..Driving.a.car.or.van
1                                                  18
2                                                  19
3                                                  24
4                                                  33
5                                                 227
6                                                 220
  Method.of.travel.to.workplace..Passenger.in.a.car.or.van
1                                                        0
2                                                        3
3                                                        7
4                                                        1
5                                                       10
6                                                       21
  Method.of.travel.to.workplace..Bicycle Method.of.travel.to.workplace..On.foot
1                                     24                                    109
2                                     25                                     92
3                                     62                                    143
4                                     18                                     90
5                                      6                                     61
6                                     21                                     71
  Method.of.travel.to.workplace..Other.method.of.travel.to.work
1                                                             4
2                                                             7
3                                                            17
4                                                             8
5                                                            17
6                                                            19</code></pre>
</div>
</div>
<p>So, that’s a <em>really</em> basic example of how to use a function.</p>
<p>Let me show you how functions can be used to clean datasets programmatically:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Function cleans the raw census dataset</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>cleandb <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Select columns</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(geography.code, </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>           Method.of.travel.to.workplace..Total..All.usual.residents.aged.<span class="fl">16.</span>years.and.over.in.employment.the.week.before.the.census,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>           Method.of.travel.to.workplace..Train) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">"LSOA21CD"</span>, <span class="st">"total"</span>, <span class="st">"train"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pctTrain =</span> (train <span class="sc">/</span> total) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Return the new dataframe</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that the function has been specified, you can pass your dataset through it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Pass census data through the new function</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>cleaned <span class="ot">&lt;-</span> <span class="fu">cleandb</span>(db)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Look at it</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cleaned)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   LSOA21CD total train  pctTrain
1 E01000001   866    17  1.963048
2 E01000002   881    10  1.135074
3 E01000003  1000    21  2.100000
4 E01000005   496    25  5.040323
5 E01000006   888   104 11.711712
6 E01000007  1385   177 12.779783</code></pre>
</div>
</div>
<p>There are lots of reasons why this approach is useful:</p>
<ol type="1">
<li>Can provide a standard set of code chunks to clean data from NOMIS, and other sources</li>
<li>Can be looped across multiple different datasets</li>
<li>Can be customised to perform different steps of cleaning that you need for your use case.</li>
</ol>
<p>However, perhaps the most useful thing functions can do, is be used to apply an API query and return a cleaned dataset for your use.</p>
<p>Let’s have a look at an example: <a href="https://github.com/patrickballantyne/tidylodes"><code>tidylodes</code></a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/tidylodes.png" class="img-fluid figure-img"></p>
<figcaption>tidylodes</figcaption>
</figure>
</div>
<p>We can implement some of these techniques and ideas to automate scraping of data from NOMIS.</p>
<p>For example, take the URL we set above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "https://www.nomisweb.co.uk/output/census/2021/census2021-ts061.zip"</code></pre>
</div>
</div>
<p>If we wrote a function that could enable specification of a different table number, we could build a pipeline where you only have to change a couple of characters to return a cleaned dataset for your reports.</p>
<p>For example, the other URL I provided in my solution above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>url2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "https://www.nomisweb.co.uk/output/census/2021/census2021-ts066.zip"</code></pre>
</div>
</div>
<p>You’ll notice the only difference with this URL is the <code>ts066</code> string at the end of the URL. Let’s start building a function that can swap these different characters in and out:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>downloadNOMIS <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="st">"ts061"</span>) {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Create the URL, based on the character supplied in x</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.nomisweb.co.uk/output/census/2021/census2021-"</span>, x, <span class="st">".zip"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(url)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s test this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">downloadNOMIS</span>(<span class="st">"ts061"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "https://www.nomisweb.co.uk/output/census/2021/census2021-ts061.zip"</code></pre>
</div>
</div>
<p>And then with a different table number</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">downloadNOMIS</span>(<span class="st">"ts066"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "https://www.nomisweb.co.uk/output/census/2021/census2021-ts066.zip"</code></pre>
</div>
</div>
<p>Ok, so now we need to add to the function, to get R to download from the URL:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>downloadNOMIS <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="st">"ts061"</span>) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Create the URL, based on the character supplied in x</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.nomisweb.co.uk/output/census/2021/census2021-"</span>, x, <span class="st">".zip"</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Download</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(url, <span class="st">"table.zip"</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Test it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">downloadNOMIS</span>(<span class="st">"ts066"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now if you go into your working directory, you should have a .zip folder called <code>table</code>.</p>
<p>Final steps: unzipping and checking all the files are there:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>downloadNOMIS <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="st">"ts061"</span>) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Create the URL, based on the character supplied in x</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.nomisweb.co.uk/output/census/2021/census2021-"</span>, x, <span class="st">".zip"</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Download</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(url, <span class="st">"table.zip"</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Unzip the files</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  outDir2 <span class="ot">&lt;-</span> <span class="st">"data/tableUZ"</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Unzip the folder to the data/unzip folder</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(<span class="st">"table.zip"</span>, <span class="at">exdir =</span> outDir2)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now run the command for a table of your choosing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">downloadNOMIS</span>(<span class="st">"ts004"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can check this has worked by looking at the files available in the <code>tableUZ</code> folder, set up in the function above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"data/tableUZ"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "census2021-ts001-ctry.csv"  "census2021-ts001-lsoa.csv" 
 [3] "census2021-ts001-ltla.csv"  "census2021-ts001-msoa.csv" 
 [5] "census2021-ts001-oa.csv"    "census2021-ts001-rgn.csv"  
 [7] "census2021-ts001-utla.csv"  "census2021-ts002-ctry.csv" 
 [9] "census2021-ts002-lsoa..csv" "census2021-ts002-ltla.csv" 
[11] "census2021-ts002-msoa..csv" "census2021-ts002-oa.csv"   
[13] "census2021-ts002-rgn.csv"   "census2021-ts002-utla.csv" 
[15] "census2021-ts003-ctry.csv"  "census2021-ts003-lsoa.csv" 
[17] "census2021-ts003-ltla.csv"  "census2021-ts003-msoa.csv" 
[19] "census2021-ts003-oa.csv"    "census2021-ts003-rgn.csv"  
[21] "census2021-ts003-utla.csv"  "census2021-ts004-ctry.csv" 
[23] "census2021-ts004-llta.csv"  "census2021-ts004-lsoa.csv" 
[25] "census2021-ts004-msoa.csv"  "census2021-ts004-oa.csv"   
[27] "census2021-ts004-rgn.csv"   "census2021-ts004-ulta.csv" 
[29] "metadata"                  </code></pre>
</div>
</div>
<p>Awesome! You have created a function that enables you to have access to tables of data from NOMIS very easily. Finally, you might be interested in asking the function to read in a specific file - you can do this easily from NOMIS as the file naming protocols are very organised.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>downloadNOMIS <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="st">"ts061"</span>) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Create the URL, based on the character supplied in x</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.nomisweb.co.uk/output/census/2021/census2021-"</span>, x, <span class="st">".zip"</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Download</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(url, <span class="st">"table.zip"</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Unzip the files</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  outDir2 <span class="ot">&lt;-</span> <span class="st">"data/tableUZ"</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Unzip the folder to the data/unzip folder</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(<span class="st">"table.zip"</span>, <span class="at">exdir =</span> outDir2)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Read in the regional level data</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  db <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste0</span>(<span class="st">"data/tableUZ/census2021-"</span>, x, <span class="st">"-rgn.csv"</span>))</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(db)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Test it</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Download and read in</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">downloadNOMIS</span>(<span class="st">"ts003"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Inspect</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  date                geography geography.code
1 2021               North East      E12000001
2 2021               North West      E12000002
3 2021 Yorkshire and The Humber      E12000003
4 2021            East Midlands      E12000004
5 2021            West Midlands      E12000005
6 2021                     East      E12000006
  Household.composition..Total..measures..Value
1                                       1175683
2                                       3153406
3                                       2330657
4                                       2037334
5                                       2429493
6                                       2628778
  Household.composition..One.person.household..measures..Value
1                                                       395924
2                                                      1014913
3                                                       733558
4                                                       597177
5                                                       725807
6                                                       759808
  Household.composition..One.person.household..Aged.66.years.and.over..measures..Value
1                                                                               167832
2                                                                               420823
3                                                                               309721
4                                                                               264630
5                                                                               318108
6                                                                               347326
  Household.composition..One.person.household..Other..measures..Value
1                                                              228092
2                                                              594090
3                                                              423837
4                                                              332547
5                                                              407699
6                                                              412482
  Household.composition..Single.family.household..measures..Value
1                                                          731124
2                                                         1961888
3                                                         1471340
4                                                         1317959
5                                                         1549864
6                                                         1714480
  Household.composition..Single.family.household..All.aged.66.years.and.over..measures..Value
1                                                                                      112397
2                                                                                      278671
3                                                                                      221778
4                                                                                      209388
5                                                                                      231216
6                                                                                      272511
  Household.composition..Single.family.household..Married.or.civil.partnership.couple..measures..Value
1                                                                                               331330
2                                                                                               904487
3                                                                                               687238
4                                                                                               632498
5                                                                                               741413
6                                                                                               848252
  Household.composition..Single.family.household..Married.or.civil.partnership.couple..No.children..measures..Value
1                                                                                                            129507
2                                                                                                            312295
3                                                                                                            259341
4                                                                                                            236710
5                                                                                                            248508
6                                                                                                            287375
  Household.composition..Single.family.household..Married.or.civil.partnership.couple..Dependent.children..measures..Value
1                                                                                                                   135625
2                                                                                                                   412594
3                                                                                                                   305595
4                                                                                                                   280529
5                                                                                                                   345254
6                                                                                                                   406526
  Household.composition..Single.family.household..Married.or.civil.partnership.couple..All.children.non.dependent..measures..Value
1                                                                                                                            66198
2                                                                                                                           179598
3                                                                                                                           122302
4                                                                                                                           115259
5                                                                                                                           147651
6                                                                                                                           154351
  Household.composition..Single.family.household..Cohabiting.couple.family..measures..Value
1                                                                                    137302
2                                                                                    373006
3                                                                                    291532
4                                                                                    253787
5                                                                                    272420
6                                                                                    309554
  Household.composition..Single.family.household..Cohabiting.couple.family..No.children..measures..Value
1                                                                                                  70052
2                                                                                                 192405
3                                                                                                 153710
4                                                                                                 134608
5                                                                                                 137757
6                                                                                                 164306
  Household.composition..Single.family.household..Cohabiting.couple.family..With.dependent.children..measures..Value
1                                                                                                              57542
2                                                                                                             155174
3                                                                                                             119334
4                                                                                                             103354
5                                                                                                             115766
6                                                                                                             125253
  Household.composition..Single.family.household..Cohabiting.couple.family..All.children.non.dependent..measures..Value
1                                                                                                                  9708
2                                                                                                                 25427
3                                                                                                                 18488
4                                                                                                                 15825
5                                                                                                                 18897
6                                                                                                                 19995
  Household.composition..Single.family.household..Lone.parent.family..measures..Value
1                                                                              143417
2                                                                              382496
3                                                                              256459
4                                                                              209278
5                                                                              287205
6                                                                              268439
  Household.composition..Single.family.household..Lone.parent.family..With.dependent.children..measures..Value
1                                                                                                        94314
2                                                                                                       241480
3                                                                                                       168688
4                                                                                                       132437
5                                                                                                       180039
6                                                                                                       166653
  Household.composition..Single.family.household..Lone.parent.family..All.children.non.dependent..measures..Value
1                                                                                                           49103
2                                                                                                          141016
3                                                                                                           87771
4                                                                                                           76841
5                                                                                                          107166
6                                                                                                          101786
  Household.composition..Single.family.household..Other.single.family.household..measures..Value
1                                                                                           6678
2                                                                                          23228
3                                                                                          14333
4                                                                                          13008
5                                                                                          17610
6                                                                                          15724
  Household.composition..Single.family.household..Other.single.family.household..Other.family.composition..measures..Value
1                                                                                                                     6678
2                                                                                                                    23228
3                                                                                                                    14333
4                                                                                                                    13008
5                                                                                                                    17610
6                                                                                                                    15724
  Household.composition..Other.household.types..measures..Value
1                                                         48635
2                                                        176605
3                                                        125759
4                                                        122198
5                                                        153822
6                                                        154490
  Household.composition..Other.household.types..With.dependent.children..measures..Value
1                                                                                  18689
2                                                                                  73084
3                                                                                  51557
4                                                                                  49543
5                                                                                  72712
6                                                                                  63676
  Household.composition..Other.household.types..Other..including.all.full.time.students.and.all.aged.66.years.and.over..measures..Value
1                                                                                                                                 29946
2                                                                                                                                103521
3                                                                                                                                 74202
4                                                                                                                                 72655
5                                                                                                                                 81110
6                                                                                                                                 90814</code></pre>
</div>
</div>
<p>The final thing I want to show you before we move off of functions is how to apply functions sequentially. Functions can be applied to lists really easily using the <code>lapply()</code> command. This means you could supply multiple names of tables that you want, and get R to download, read and clean them for you using the techniques I have just shown you.</p>
<p>For example, take a list like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>ls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ts001"</span>, <span class="st">"ts002"</span>, <span class="st">"ts003"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>ls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ts001" "ts002" "ts003"</code></pre>
</div>
</div>
<p>We can apply the <code>downloadNOMIS</code> function to these three tables, to read in the regional-level tables. The way to do this is to use the <code>lapply</code> command, which takes as arguments 1) a list and 2) a function to apply over the list.</p>
<p>In our case this would be:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Download three tables from NOMIS</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>tables <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ls, downloadNOMIS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once this has finished running, you are left with a list of tables, see:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(tables)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ :'data.frame':   10 obs. of  6 variables:
  ..$ date                                                              : int [1:10] 2021 2021 2021 2021 2021 2021 2021 2021 2021 2021
  ..$ geography                                                         : chr [1:10] "North East" "North West" "Yorkshire and The Humber" "East Midlands" ...
  ..$ geography.code                                                    : chr [1:10] "E12000001" "E12000002" "E12000003" "E12000004" ...
  ..$ Residence.type..Total..measures..Value                            : int [1:10] 2647013 7417397 5480774 4880054 5950757 6335074 8799728 9278065 5701186 3107494
  ..$ Residence.type..Lives.in.a.household..measures..Value             : int [1:10] 2594828 7290560 5376740 4778018 5854512 6238659 8699834 9088552 5582599 3051549
  ..$ Residence.type..Lives.in.a.communal.establishment..measures..Value: int [1:10] 52185 126837 104034 102036 96245 96415 99894 189513 118587 55945
 $ :'data.frame':   10 obs. of  21 variables:
  ..$ date                                                                                                                                                                                       : int [1:10] 2021 2021 2021 2021 2021 2021 2021 2021 2021 2021
  ..$ geography                                                                                                                                                                                  : chr [1:10] "North East" "North West" "Yorkshire and The Humber" "East Midlands" ...
  ..$ geography.code                                                                                                                                                                             : chr [1:10] "E12000001" "E12000002" "E12000003" "E12000004" ...
  ..$ Marital.and.civil.partnership.status..Total..measures..Value                                                                                                                               : int [1:10] 2178960 6025636 4460298 3998045 4801329 5148282 7103985 7554580 4735840 2559415
  ..$ Marital.and.civil.partnership.status..Never.married.and.never.registered.a.civil.partnership..measures..Value                                                                              : int [1:10] 829791 2372877 1679861 1442049 1781208 1791650 3282327 2628945 1641415 951656
  ..$ Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..measures..Value                                                                                        : int [1:10] 937083 2575107 1971162 1832929 2172973 2429227 2843230 3596697 2203234 1121459
  ..$ Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..Married..measures..Value                                                                               : int [1:10] 933521 2565016 1962879 1825699 2164831 2419645 2819968 3579942 2192574 1116418
  ..$ Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..Married..Opposite.sex..measures..Value                                                                 : int [1:10] 928213 2548818 1951385 1815824 2153949 2407966 2793106 3557428 2179876 1109656
  ..$ Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..Married..Same.sex..measures..Value                                                                     : int [1:10] 5308 16198 11494 9875 10882 11679 26862 22514 12698 6762
  ..$ Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..In.a.registered.civil.partnership..measures..Value                                                     : int [1:10] 3562 10091 8283 7230 8142 9582 23262 16755 10660 5041
  ..$ Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..In.a.registered.civil.partnership..Opposite.sex..measures..Value                                       : int [1:10] 1312 3408 2975 2704 3304 3470 7946 5419 3528 1730
  ..$ Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..In.a.registered.civil.partnership..Same.sex..measures..Value                                           : int [1:10] 2250 6683 5308 4526 4838 6112 15316 11336 7132 3311
  ..$ Marital.and.civil.partnership.status..Separated..but.still.legally.married.or.still.legally.in.a.civil.partnership..measures..Value                                                        : int [1:10] 54358 136428 102350 88980 110711 113455 165884 161395 99960 52468
  ..$ Marital.and.civil.partnership.status..Separated..but.still.legally.married.or.still.legally.in.a.civil.partnership..Separated..but.still.married..measures..Value                          : int [1:10] 54029 135494 101660 88398 110090 112791 164083 160211 99224 52074
  ..$ Marital.and.civil.partnership.status..Separated..but.still.legally.married.or.still.legally.in.a.civil.partnership..Separated..but.still.in.a.registered.civil.partnership..measures..Value: int [1:10] 329 934 690 582 621 664 1801 1184 736 394
  ..$ Marital.and.civil.partnership.status..Divorced.or.civil.partnership.dissolved..measures..Value                                                                                             : int [1:10] 206974 550417 420235 378618 424612 490720 516854 705127 478079 252707
  ..$ Marital.and.civil.partnership.status..Divorced.or.civil.partnership.dissolved..Divorced..measures..Value                                                                                   : int [1:10] 206505 549121 419338 377750 423752 489726 514117 703179 476871 252159
  ..$ Marital.and.civil.partnership.status..Divorced.or.civil.partnership.dissolved..Formerly.in.a.civil.partnership.now.legally.dissolved..measures..Value                                      : int [1:10] 469 1296 897 868 860 994 2737 1948 1208 548
  ..$ Marital.and.civil.partnership.status..Widowed.or.surviving.civil.partnership.partner..measures..Value                                                                                      : int [1:10] 150754 390807 286690 255469 311825 323230 295690 462416 313152 181125
  ..$ Marital.and.civil.partnership.status..Widowed.or.surviving.civil.partnership.partner..Widowed..measures..Value                                                                             : int [1:10] 150610 390312 286369 255208 311517 322831 294837 461641 312673 180925
  ..$ Marital.and.civil.partnership.status..Widowed.or.surviving.civil.partnership.partner..Surviving.partner.from.civil.partnership..measures..Value                                            : int [1:10] 144 495 321 261 308 399 853 775 479 200
 $ :'data.frame':   10 obs. of  25 variables:
  ..$ date                                                                                                                                 : int [1:10] 2021 2021 2021 2021 2021 2021 2021 2021 2021 2021
  ..$ geography                                                                                                                            : chr [1:10] "North East" "North West" "Yorkshire and The Humber" "East Midlands" ...
  ..$ geography.code                                                                                                                       : chr [1:10] "E12000001" "E12000002" "E12000003" "E12000004" ...
  ..$ Household.composition..Total..measures..Value                                                                                        : int [1:10] 1175683 3153406 2330657 2037334 2429493 2628778 3423890 3807967 2448881 1347114
  ..$ Household.composition..One.person.household..measures..Value                                                                         : int [1:10] 395924 1014913 733558 597177 725807 759808 1001983 1081739 741323 429559
  ..$ Household.composition..One.person.household..Aged.66.years.and.over..measures..Value                                                 : int [1:10] 167832 420823 309721 264630 318108 347326 313049 503974 356329 196056
  ..$ Household.composition..One.person.household..Other..measures..Value                                                                  : int [1:10] 228092 594090 423837 332547 407699 412482 688934 577765 384994 233503
  ..$ Household.composition..Single.family.household..measures..Value                                                                      : int [1:10] 731124 1961888 1471340 1317959 1549864 1714480 1986263 2473698 1556311 850096
  ..$ Household.composition..Single.family.household..All.aged.66.years.and.over..measures..Value                                          : int [1:10] 112397 278671 221778 209388 231216 272511 148209 386986 284123 138010
  ..$ Household.composition..Single.family.household..Married.or.civil.partnership.couple..measures..Value                                 : int [1:10] 331330 904487 687238 632498 741413 848252 977165 1260379 747034 386697
  ..$ Household.composition..Single.family.household..Married.or.civil.partnership.couple..No.children..measures..Value                    : int [1:10] 129507 312295 259341 236710 248508 287375 256539 420975 288960 145009
  ..$ Household.composition..Single.family.household..Married.or.civil.partnership.couple..Dependent.children..measures..Value             : int [1:10] 135625 412594 305595 280529 345254 406526 541099 619300 328880 160019
  ..$ Household.composition..Single.family.household..Married.or.civil.partnership.couple..All.children.non.dependent..measures..Value     : int [1:10] 66198 179598 122302 115259 147651 154351 179527 220104 129194 81669
  ..$ Household.composition..Single.family.household..Cohabiting.couple.family..measures..Value                                            : int [1:10] 137302 373006 291532 253787 272420 309554 349419 433453 288505 155649
  ..$ Household.composition..Single.family.household..Cohabiting.couple.family..No.children..measures..Value                               : int [1:10] 70052 192405 153710 134608 137757 164306 229339 240827 163957 77093
  ..$ Household.composition..Single.family.household..Cohabiting.couple.family..With.dependent.children..measures..Value                   : int [1:10] 57542 155174 119334 103354 115766 125253 101486 166572 108519 67941
  ..$ Household.composition..Single.family.household..Cohabiting.couple.family..All.children.non.dependent..measures..Value                : int [1:10] 9708 25427 18488 15825 18897 19995 18594 26054 16029 10615
  ..$ Household.composition..Single.family.household..Lone.parent.family..measures..Value                                                  : int [1:10] 143417 382496 256459 209278 287205 268439 453937 369841 223832 161836
  ..$ Household.composition..Single.family.household..Lone.parent.family..With.dependent.children..measures..Value                         : int [1:10] 94314 241480 168688 132437 180039 166653 267852 227161 138453 102274
  ..$ Household.composition..Single.family.household..Lone.parent.family..All.children.non.dependent..measures..Value                      : int [1:10] 49103 141016 87771 76841 107166 101786 186085 142680 85379 59562
  ..$ Household.composition..Single.family.household..Other.single.family.household..measures..Value                                       : int [1:10] 6678 23228 14333 13008 17610 15724 57533 23039 12817 7904
  ..$ Household.composition..Single.family.household..Other.single.family.household..Other.family.composition..measures..Value             : int [1:10] 6678 23228 14333 13008 17610 15724 57533 23039 12817 7904
  ..$ Household.composition..Other.household.types..measures..Value                                                                        : int [1:10] 48635 176605 125759 122198 153822 154490 435644 252530 151247 67459
  ..$ Household.composition..Other.household.types..With.dependent.children..measures..Value                                               : int [1:10] 18689 73084 51557 49543 72712 63676 160669 93493 46913 26078
  ..$ Household.composition..Other.household.types..Other..including.all.full.time.students.and.all.aged.66.years.and.over..measures..Value: int [1:10] 29946 103521 74202 72655 81110 90814 274975 159037 104334 41381</code></pre>
</div>
</div>
<p>You can select one out individually:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select the first table</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> tables[[<span class="dv">1</span>]]</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(table1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  date                geography geography.code
1 2021               North East      E12000001
2 2021               North West      E12000002
3 2021 Yorkshire and The Humber      E12000003
4 2021            East Midlands      E12000004
5 2021            West Midlands      E12000005
6 2021                     East      E12000006
  Residence.type..Total..measures..Value
1                                2647013
2                                7417397
3                                5480774
4                                4880054
5                                5950757
6                                6335074
  Residence.type..Lives.in.a.household..measures..Value
1                                               2594828
2                                               7290560
3                                               5376740
4                                               4778018
5                                               5854512
6                                               6238659
  Residence.type..Lives.in.a.communal.establishment..measures..Value
1                                                              52185
2                                                             126837
3                                                             104034
4                                                             102036
5                                                              96245
6                                                              96415</code></pre>
</div>
</div>
<p>Or because they all have the <code>geography.code</code>, <code>geography</code> and <code>date</code> column, you can just attach them into one big table. This relies on the use of the <code>purrr</code> package, which is full of useful tools for working with lists.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Bind together</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> tables <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(left_join, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"geography"</span>, <span class="st">"geography.code"</span>))</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Have a look</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "date"                                                                                                                                                                                       
 [2] "geography"                                                                                                                                                                                  
 [3] "geography.code"                                                                                                                                                                             
 [4] "Residence.type..Total..measures..Value"                                                                                                                                                     
 [5] "Residence.type..Lives.in.a.household..measures..Value"                                                                                                                                      
 [6] "Residence.type..Lives.in.a.communal.establishment..measures..Value"                                                                                                                         
 [7] "Marital.and.civil.partnership.status..Total..measures..Value"                                                                                                                               
 [8] "Marital.and.civil.partnership.status..Never.married.and.never.registered.a.civil.partnership..measures..Value"                                                                              
 [9] "Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..measures..Value"                                                                                        
[10] "Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..Married..measures..Value"                                                                               
[11] "Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..Married..Opposite.sex..measures..Value"                                                                 
[12] "Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..Married..Same.sex..measures..Value"                                                                     
[13] "Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..In.a.registered.civil.partnership..measures..Value"                                                     
[14] "Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..In.a.registered.civil.partnership..Opposite.sex..measures..Value"                                       
[15] "Marital.and.civil.partnership.status..Married.or.in.a.registered.civil.partnership..In.a.registered.civil.partnership..Same.sex..measures..Value"                                           
[16] "Marital.and.civil.partnership.status..Separated..but.still.legally.married.or.still.legally.in.a.civil.partnership..measures..Value"                                                        
[17] "Marital.and.civil.partnership.status..Separated..but.still.legally.married.or.still.legally.in.a.civil.partnership..Separated..but.still.married..measures..Value"                          
[18] "Marital.and.civil.partnership.status..Separated..but.still.legally.married.or.still.legally.in.a.civil.partnership..Separated..but.still.in.a.registered.civil.partnership..measures..Value"
[19] "Marital.and.civil.partnership.status..Divorced.or.civil.partnership.dissolved..measures..Value"                                                                                             
[20] "Marital.and.civil.partnership.status..Divorced.or.civil.partnership.dissolved..Divorced..measures..Value"                                                                                   
[21] "Marital.and.civil.partnership.status..Divorced.or.civil.partnership.dissolved..Formerly.in.a.civil.partnership.now.legally.dissolved..measures..Value"                                      
[22] "Marital.and.civil.partnership.status..Widowed.or.surviving.civil.partnership.partner..measures..Value"                                                                                      
[23] "Marital.and.civil.partnership.status..Widowed.or.surviving.civil.partnership.partner..Widowed..measures..Value"                                                                             
[24] "Marital.and.civil.partnership.status..Widowed.or.surviving.civil.partnership.partner..Surviving.partner.from.civil.partnership..measures..Value"                                            
[25] "Household.composition..Total..measures..Value"                                                                                                                                              
[26] "Household.composition..One.person.household..measures..Value"                                                                                                                               
[27] "Household.composition..One.person.household..Aged.66.years.and.over..measures..Value"                                                                                                       
[28] "Household.composition..One.person.household..Other..measures..Value"                                                                                                                        
[29] "Household.composition..Single.family.household..measures..Value"                                                                                                                            
[30] "Household.composition..Single.family.household..All.aged.66.years.and.over..measures..Value"                                                                                                
[31] "Household.composition..Single.family.household..Married.or.civil.partnership.couple..measures..Value"                                                                                       
[32] "Household.composition..Single.family.household..Married.or.civil.partnership.couple..No.children..measures..Value"                                                                          
[33] "Household.composition..Single.family.household..Married.or.civil.partnership.couple..Dependent.children..measures..Value"                                                                   
[34] "Household.composition..Single.family.household..Married.or.civil.partnership.couple..All.children.non.dependent..measures..Value"                                                           
[35] "Household.composition..Single.family.household..Cohabiting.couple.family..measures..Value"                                                                                                  
[36] "Household.composition..Single.family.household..Cohabiting.couple.family..No.children..measures..Value"                                                                                     
[37] "Household.composition..Single.family.household..Cohabiting.couple.family..With.dependent.children..measures..Value"                                                                         
[38] "Household.composition..Single.family.household..Cohabiting.couple.family..All.children.non.dependent..measures..Value"                                                                      
[39] "Household.composition..Single.family.household..Lone.parent.family..measures..Value"                                                                                                        
[40] "Household.composition..Single.family.household..Lone.parent.family..With.dependent.children..measures..Value"                                                                               
[41] "Household.composition..Single.family.household..Lone.parent.family..All.children.non.dependent..measures..Value"                                                                            
[42] "Household.composition..Single.family.household..Other.single.family.household..measures..Value"                                                                                             
[43] "Household.composition..Single.family.household..Other.single.family.household..Other.family.composition..measures..Value"                                                                   
[44] "Household.composition..Other.household.types..measures..Value"                                                                                                                              
[45] "Household.composition..Other.household.types..With.dependent.children..measures..Value"                                                                                                     
[46] "Household.composition..Other.household.types..Other..including.all.full.time.students.and.all.aged.66.years.and.over..measures..Value"                                                      </code></pre>
</div>
</div>
</section>
</section>
<section id="using-the-nomis-api" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="using-the-nomis-api"><span class="header-section-number">3.3</span> Using the NOMIS API</h2>
<p>One of the things that you see more commonly in practice is the construction of specific R packages used to access APIs, with supporting documentation and specific functions that make it easier to use the API.</p>
<p>One such example is <a href="https://docs.evanodell.com/nomisr/articles/introduction.html"><code>nomisr</code></a>, which is an R package that was built to enable users to query data from NOMIS. It is free to access and contains up-to-date official statistics including data from the latest Census, Labour Force Survey and DWP benefit statistics.</p>
<p>In the section that follows, I’m going to be showing you how to use the nomisr package to download datasets.</p>
<p>Vast amounts of data are available through NOMIS, so you need to use some of the different functions within <code>nomisr</code> to identify the specific datasets you want to use. An example is presented below which searches for datasets within NOMIS that are specifically about ‘Travel’:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Search for data on Labour Force</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>search <span class="ot">&lt;-</span> <span class="fu">nomis_search</span>(<span class="st">"*Travel*"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This returns a dataframe (which you should see in your environment) that describes all of the different NOMIS held datasets where ‘Travel’ is mentioned. The column perhaps of most interest is the short name for the different datasets, which you can inspect below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Have a look at the first six datasets </span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(search<span class="sc">$</span>name.value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2001 census - UK travel flows (local authority)"            
[2] "2001 census - Scottish travel flows (local authority)"      
[3] "2001 census - UK travel flows (ward)"                       
[4] "QS702EW - Distance travelled to work"                       
[5] "WD702EW - Distance travelled to work (Workday population)"  
[6] "WP702EW - Distance travelled to work (Workplace population)"</code></pre>
</div>
</div>
<p>If you open up the dataframe in your environment and scroll down you should see one row has the value - <code>TS061 - Method used to travel to work</code> - which is the one we’ve been using a lot in this practical.</p>
<p>We can filter to this row very easily using the <code>filter()</code> command that we introduced yesterday:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Filter to row of interest</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>search_sub <span class="ot">&lt;-</span> search <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name.value <span class="sc">==</span> <span class="st">"TS061 - Method used to travel to work"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Have a look at the result</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>search_sub</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
  agencyid id        uri     version annotations.annotation components.attribute
  &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt; &lt;list&gt;                 &lt;list&gt;              
1 NOMIS    NM_2078_1 Nm-207…       1 &lt;df [13 × 2]&gt;          &lt;df [7 × 4]&gt;        
# ℹ 6 more variables: components.dimension &lt;list&gt;,
#   components.primarymeasure.conceptref &lt;chr&gt;,
#   components.timedimension.codelist &lt;chr&gt;,
#   components.timedimension.conceptref &lt;chr&gt;, name.value &lt;chr&gt;,
#   name.lang &lt;chr&gt;</code></pre>
</div>
</div>
<p>Notice how the table ID is <code>NM_2078_1</code>. We can get some metadata for this dataset very easily using the nomis_get_metadata() command. First, let’s see what measures are available:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Supply the ID of the row we're interested in, and the second parameters specifies we'd like to know more about the measures</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nomis_get_metadata</span>(search_sub<span class="sc">$</span>id, <span class="st">"measures"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  id    label.en description.en
  &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;         
1 20100 value    value         
2 20301 percent  percent       </code></pre>
</div>
</div>
<p>So for TS061, we can get both raw counts (‘value’) and percent. Notice how the ID for counts is <code>20100</code> and the ID for percent is <code>20301</code>. Let’s now see what geographies are available:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Supply the ID of the row we're interested in, and the second parameter specifies that we want to know more about geographies</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nomis_get_metadata</span>(search_sub<span class="sc">$</span>id, <span class="st">"geography"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  id         parentCode label.en          description.en   
  &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;             &lt;chr&gt;            
1 2092957703 &lt;NA&gt;       England and Wales England and Wales
2 2092957699 &lt;NA&gt;       England           England          
3 2092957700 2092957700 Wales             Wales            </code></pre>
</div>
</div>
<p>Ok, so this is telling us the different geographic levels we can download the data for. However, if we add an additional parameter to this, we can also see the specific geographic units that this data is available at:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add in an additional parameter</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nomis_get_metadata</span>(search_sub<span class="sc">$</span>id, <span class="st">"geography"</span>, <span class="st">"TYPE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 3
   id      label.en                                               description.en
   &lt;chr&gt;   &lt;chr&gt;                                                  &lt;chr&gt;         
 1 TYPE150 2021 output areas                                      2021 output a…
 2 TYPE151 2021 super output areas - lower layer                  2021 super ou…
 3 TYPE152 2021 super output areas - middle layer                 2021 super ou…
 4 TYPE153 2022 wards                                             2022 wards    
 5 TYPE154 2022 local authorities: districts                      2022 local au…
 6 TYPE155 2022 local authorities: counties                       2022 local au…
 7 TYPE168 2021 national parks                                    2021 national…
 8 TYPE423 local authorities: county / unitary (as of April 2023) local authori…
 9 TYPE424 local authorities: district / unitary (as of April 20… local authori…
10 TYPE459 local enterprise partnerships (as of April 2021)       local enterpr…
11 TYPE480 regions                                                regions       
12 TYPE499 countries                                              countries     </code></pre>
</div>
</div>
<p>So there are a variety of different geographic levels at which we can download the dataset, including LSOA - see <code>2021 super output areas - lower layer</code>. Notice how the ID for LSOAs is <code>TYPE151</code>.</p>
<p>Those steps we have just performed basically give us everything we need to download the dataset directly from the NOMIS API using the package, instead of downloading the .zip files directly. Let’s download the file - it could take a while! If you don’t understand any of the specific inputs to this line of code, feel free to shout Patrick to talk it through.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Download the file</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>db_v2 <span class="ot">&lt;-</span> <span class="fu">nomis_get_data</span>(<span class="at">id =</span> <span class="st">"NM_2078_1"</span>, <span class="at">time =</span> <span class="st">"latest"</span>, <span class="at">geography =</span> <span class="fu">c</span>(<span class="st">"TYPE151"</span>), <span class="at">measures =</span> <span class="st">"20301"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 1 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 2 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 3 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 4 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 5 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 6 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 7 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 8 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 9 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 10 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 11 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 12 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 13 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 14 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 15 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 16 of 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Retrieving additional pages 17 of 17</code></pre>
</div>
</div>
<p>The format the data is presented in is not the most intuitive, so those reshaping skills we acquired yesterday are going to come in handy here again!</p>
<p>Firstly, let’s get the columns we need for our analysis - LSOA codes, the different modes of transport and the actual reported values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Select columns of interest</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>db_clean <span class="ot">&lt;-</span> db_v2 <span class="sc">%&gt;%</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(GEOGRAPHY_CODE, C2021_TTWMETH_12_NAME, OBS_VALUE) </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Inspect</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(db_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  GEOGRAPHY_CODE C2021_TTWMETH_12_NAME                                 OBS_VALUE
  &lt;chr&gt;          &lt;chr&gt;                                                     &lt;dbl&gt;
1 E01011954      Total: All usual residents aged 16 years and over in…     100  
2 E01011954      Work mainly at or from home                                11.9
3 E01011954      Underground, metro, light rail, tram                        0  
4 E01011954      Train                                                       0.3
5 E01011954      Bus, minibus or coach                                       4.1
6 E01011954      Taxi                                                        2  </code></pre>
</div>
</div>
<p>So as you can see from the table, it’s actually in a long format, whereas we might want it to be in a wide format, where each column is the % of people using each transport mode. Let’s use the <code>pivot_wider()</code> command to change this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Go from long to wide</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>db_clean <span class="ot">&lt;-</span> db_clean <span class="sc">%&gt;%</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> C2021_TTWMETH_12_NAME, <span class="at">values_from =</span> OBS_VALUE)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Inspect</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(db_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 13
  GEOGRAPHY_CODE Total: All usual residents aged 16 yea…¹ Work mainly at or fr…²
  &lt;chr&gt;                                             &lt;dbl&gt;                  &lt;dbl&gt;
1 E01011954                                           100                   11.9
2 E01011969                                           100                   14.7
3 E01011970                                           100                   19.5
4 E01011971                                           100                   19  
5 E01033465                                           100                   22.2
6 E01033467                                           100                   20.6
# ℹ abbreviated names:
#   ¹​`Total: All usual residents aged 16 years and over in employment the week before the census`,
#   ²​`Work mainly at or from home`
# ℹ 10 more variables: `Underground, metro, light rail, tram` &lt;dbl&gt;,
#   Train &lt;dbl&gt;, `Bus, minibus or coach` &lt;dbl&gt;, Taxi &lt;dbl&gt;,
#   `Motorcycle, scooter or moped` &lt;dbl&gt;, `Driving a car or van` &lt;dbl&gt;,
#   `Passenger in a car or van` &lt;dbl&gt;, Bicycle &lt;dbl&gt;, `On foot` &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Great, that’s worked! You’ll also notice the number of rows of db_clean matches that of db (which was the file we unzipped at the start of the practical).</p>
<p>Some final data cleaning steps:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Tidy up the dataset</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>db_final <span class="ot">&lt;-</span> db_clean <span class="sc">%&gt;%</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">"LSOA21CD"</span>, <span class="st">"total"</span>, <span class="st">"work_from_home"</span>, <span class="st">"underground_metro"</span>, <span class="st">"train"</span>, <span class="st">"bus_minibus_coach"</span>, </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">"taxi"</span>, <span class="st">"motorcycle"</span>, <span class="st">"car_driving"</span>, <span class="st">"car_passenger"</span>, <span class="st">"bicycle"</span>, <span class="st">"foot"</span>, <span class="st">"other"</span>)) <span class="do">## set new names</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then we can easily produce one of the visualisations from yesterday:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Reproduce the scatter plot from yesterday's class</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> db_final, <span class="fu">aes</span>(<span class="at">x =</span> work_from_home, <span class="at">y =</span> car_driving)) <span class="sc">+</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="fl">0.35</span>) <span class="sc">+</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>) <span class="sc">+</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Population who work from home (%)"</span>, <span class="at">y =</span> <span class="st">"Population who drive to work (%)"</span>,</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Data: UK Census (2021) - 'Method of travel to work' (ts061)"</span>) <span class="sc">+</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03_dashboards-api_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Nice! You have now learned how to programmatically use the API to scrape data from NOMIS, bypassing the need to download and unzip the files directly. Now, some independent tasks to check you can reproduce the steps.</p>
<section id="independent-exercise---over-to-you" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="independent-exercise---over-to-you"><span class="header-section-number">3.3.1</span> Independent exercise - Over to you!</h3>
<ol type="1">
<li>Experiment with downloading a different dataset using the <code>nomisr</code> package, and clean it.</li>
<li>Produce an interesting visualisation using your chosen dataset.</li>
<li>(<em>optional</em>) See if you can attach the LAD names to your dataset, and produce a visualisation that examines LAD differences in your chosen dataset - recommend you choose a dataset at either LSOA or MSOA geography to use yesterday’s lookup table. If you are unsure of how to do this, you will need to go back to <code>Day 2 - Data Visualisation</code>.</li>
</ol>
</section>
</section>
<section id="building-dashboards-in-r" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="building-dashboards-in-r"><span class="header-section-number">3.4</span> Building Dashboards in R</h2>
<p>Dashboards are often a great way to share results and analyses with others. There are a number of ways you can build dashboards in R, including:</p>
<ol type="1">
<li>Using markdown (<code>flexdashboard</code> R package)</li>
<li>Using <code>R shiny</code>.</li>
</ol>
<p>The former offers you to create a dashboard with panels and pages very easily, and has significant advantages over R Shiny:</p>
<ol type="1">
<li>Minimal coding required.</li>
<li>Dashboard can be distributed as the .html file, with no server required.</li>
<li>Other packages can hook into the dashboard to add interactivity.</li>
</ol>
<section id="getting-started" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="getting-started"><span class="header-section-number">3.4.1</span> Getting started</h3>
<p>To build a dashboard using R markdown, we will need to use an alternate type of computational workbook - thus far we have been working with Quarto files (.qmd), but now we need to switch to the format that supports “Flex Dashboards”.</p>
<p>However, <code>flexdashboard</code> runs into problems when linked to an existing R project, especially one which is hooked up to Quarto.</p>
<p><strong>Important</strong> So for this part of the project please create a new directory where you want to build your dashboard. For example, I’ve created a new folder called ‘Dashboard’, which is where I will be building my dashboard. Also, make sure to copy some of the datasets we have been using into this new directory:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/directory.png" class="img-fluid figure-img"></p>
<figcaption>New Directory</figcaption>
</figure>
</div>
<p>The final step is to create a new file which will be used to build your dashboard. In R, Go to <strong>File</strong> &gt; <strong>New File</strong> &gt; <strong>R Markdown</strong> &gt; <strong>From Template</strong> &gt; <strong>Flex Dashboard</strong> (see below).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/file.png" class="img-fluid figure-img"></p>
<figcaption>New File</figcaption>
</figure>
</div>
<p>The file should open up automatically, and should look the one below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/dashboard-raw.png" class="img-fluid figure-img"></p>
<figcaption>Blank Dashboard Template</figcaption>
</figure>
</div>
<p>Now save it <strong>inside your new folder</strong> as something you can remember - e.g., dashboard.Rmd. It is vital that this new .Rmd is saved within your new folder, which should now look like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/complete.png" class="img-fluid figure-img"></p>
<figcaption>Full Directory</figcaption>
</figure>
</div>
<p>When you open up the .Rmd file, you should be able to see the ‘Knit’ button as below. If you instead see the ‘Render’ button, you’ve not saved the .rmd in your new directory. Speak to Patrick if you run into problems here.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/knit.png" class="img-fluid figure-img"></p>
<figcaption>Knit Button</figcaption>
</figure>
</div>
</section>
<section id="introduction-to-flex-dashboard" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="introduction-to-flex-dashboard"><span class="header-section-number">3.4.2</span> Introduction to Flex Dashboard</h3>
<p>For the remainder of the practical, you need to be working in your new .Rmd file. This is where you will build and deploy your dashboard, so please make sure you are working in this file - ‘dashboard.Rmd’.</p>
<p>Inside the file you will notice a couple of different things:</p>
<ol type="1">
<li>Code blocks - you will see code blocks like those you have been running in this document, which can be used to run lines of code easily.</li>
<li>YAML header - at the top of the new file is a YAML header, which is where you can set up the basic metadata for the dashboard.</li>
</ol>
<p>Have a go at changing your YAML header to the following:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/yaml.png" class="img-fluid figure-img"></p>
<figcaption>YAML</figcaption>
</figure>
</div>
<p>These parameters are doing the following:</p>
<ul>
<li><code>title</code>: sets a title to appear at the top of the dashboard.</li>
<li><code>orientation</code>: determines whether charts should be aligned in rows or columns</li>
<li><code>vertical_layout</code>: sets the dashboard to fill available browser height.</li>
</ul>
<p>Press ‘Knit’ and see what happens…</p>
<p>R should open up a new window that looks like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/first.png" class="img-fluid figure-img"></p>
<figcaption>First Dashboard</figcaption>
</figure>
</div>
<p>So you can see that the dashboard has three panes set up to host different types of visualisation. In the .Rmd file you’ll notice that each <code>##</code> denotes the start of a new column, and each <code>###</code> denotes a new pane for visualisation.</p>
<p>Let’s change the layout slightly, to create a grid of four equally sized panes. To do this you need to:</p>
<ol type="1">
<li>Change the data-width parameter to be equal for both columns</li>
<li>Add a second panel under column one</li>
</ol>
<p>Here is what the code looks like:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/resize-code.png" class="img-fluid figure-img"></p>
<figcaption>Code</figcaption>
</figure>
</div>
<p>Now press ‘Knit’ again, and see what has changed:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/resize-out.png" class="img-fluid figure-img"></p>
<figcaption>Resized</figcaption>
</figure>
</div>
<p>Cool! So the dashboard layout is set up and ready to go!</p>
</section>
<section id="independent-exercise---over-to-you-1" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="independent-exercise---over-to-you-1"><span class="header-section-number">3.4.3</span> Independent exercise - Over to you!</h3>
<ol type="1">
<li>Swap the orientation to be columns</li>
<li>See if you can set up the dashboard to be structured as 1 large panel on the left, and three on the right.</li>
<li>(<em>optional</em>) Change the section headers for each panel to list some potential visualisations you might put in each, based on yesterday’s class.</li>
</ol>
<p>SOLUTION:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/solution1.png" class="img-fluid figure-img"></p>
<figcaption>Solution</figcaption>
</figure>
</div>
</section>
<section id="embedding-visualisations" class="level3" data-number="3.4.4">
<h3 data-number="3.4.4" class="anchored" data-anchor-id="embedding-visualisations"><span class="header-section-number">3.4.4</span> Embedding visualisations</h3>
<p>When building a dashboard, a key component will be adding in a number of visualisations to enhance the information being conveyed by the dashboard. As you have seen so far, <code>flexdashboard</code> creates panes to host plots and visualisations on.</p>
<p>However, the visualisations need to be produced within the .Rmd file before they can be displayed on the dashboard itself. This is where you can use code chunks within the .Rmd file to re-run some of the analyses we did yesterday to produce visuals for the dashboard.</p>
<p>The code chunks need to be placed before the dashboard structural parameters - i.e.&nbsp;before the <code>##</code> Column commands in the script. Have a look at the example below where we read in and clean the census data we were using on Day 2:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/code-example.png" class="img-fluid figure-img"></p>
<figcaption>How to insert code</figcaption>
</figure>
</div>
<p>Then, once you have the read the data in you can produce one of the visualisations we made yesterday - such as the scatter plot we made yesterday:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/code-example2.png" class="img-fluid figure-img"></p>
<figcaption>Make a plot</figcaption>
</figure>
</div>
<p>Now the final step is to think about embedding this plot so it can be displayed on the plot. To do this, all you need to do is call the plot in one of the code blocks which are set up to host visualisations, see below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/code-example3.png" class="img-fluid figure-img"></p>
<figcaption>Embed a plot</figcaption>
</figure>
</div>
<p>Now hit ‘Knit’ and you should see this plot on the dashboard:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/dashboard-p1.png" class="img-fluid figure-img"></p>
<figcaption>First stage</figcaption>
</figure>
</div>
</section>
<section id="independent-exercise---over-to-you-30---45-mins" class="level3" data-number="3.4.5">
<h3 data-number="3.4.5" class="anchored" data-anchor-id="independent-exercise---over-to-you-30---45-mins"><span class="header-section-number">3.4.5</span> Independent exercise - Over to you!! (30 - 45 mins)</h3>
<p>Have a go at embedding some more visualisations on the dashboard. To do this you will need to reproduce lots of the analysis you did on Day 2.</p>
<p>Below I’ve included something that I put together, which is something you could aim to try and generate. Have a look at <a href="https://rstudio.github.io/flexdashboard/articles/using.html">this vignette</a> produced by the <code>flexdashboard</code> package developers for some ideas of different elements and interactive functionalities you might want to build into your dashboard.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/04/final-dashboard.png" class="img-fluid figure-img"></p>
<figcaption>Transport Dashboard</figcaption>
</figure>
</div>
</section>
</section>
<section id="other-useful-reporting-techniques" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="other-useful-reporting-techniques"><span class="header-section-number">3.5</span> Other Useful Reporting Techniques</h2>
<p>We have shown you the power of using R and Quarto for generating computational workbooks where you can view both the figures/outputs and code used to generate them, all at once.</p>
<section id="constructing-reports" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="constructing-reports"><span class="header-section-number">3.5.1</span> Constructing Reports</h3>
<p>The .html files that render alongside these .qmd files can be seen as ‘reports’ in a way. However, there is a whole host of design-related modifications you can make to the .qmd file which will enhance the appearance of the output report.</p>
<p>There is lots of useful information online about creating nice reports using R markdown - including this one from <a href="https://epirhandbook.com/en/reports-with-r-markdown.html">The Epidemiologist R Handbook</a>.</p>
</section>
<section id="routine-reporting" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="routine-reporting"><span class="header-section-number">3.5.2</span> Routine Reporting</h3>
<p>The Epidemiologist Handbook also has a really nice section on how to use R to run reports routinely, using the <code>reportfactory</code> R package. Have a a look at the <a href="https://epirhandbook.com/en/organizing-routine-reports.html">Organising routing reports</a> guide if you are interested in learning more about this!</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02_data-visualisation.html" class="pagination-link  aria-label=" &lt;span="" visualisation&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Visualisation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./04_data-modeling.html" class="pagination-link" aria-label="<span class='chapter-number'>4</span>&nbsp; <span class='chapter-title'>Data modeling</span>">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data modeling</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>